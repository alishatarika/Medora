from flask import Flask, request, jsonify, render_template
import serial
import time

app = Flask(__name__)

# --- GSM Modem Setup ---
SERIAL_PORT = "COM3"  # Change to your port
BAUD_RATE = 9600

try:
    ser = serial.Serial(SERIAL_PORT, BAUD_RATE, timeout=5)
    time.sleep(2)
except Exception as e:
    print("Error initializing GSM modem:", e)
    ser = None

def send_sms(number, message):
    if not ser:
        raise Exception("GSM modem not initialized")
    ser.write(b'AT\r')
    time.sleep(1)
    ser.write(b'AT+CMGF=1\r')
    time.sleep(1)
    ser.write(('AT+CMGS="' + number + '"\r').encode())
    time.sleep(1)
    ser.write((message + "\x1A").encode())  # Ctrl+Z to send
    time.sleep(3)

# --- Routes ---
@app.route("/")
def index():
    return render_template("index.html")

@app.route("/medora_emergencySos")
def emergency_sos():
    return render_template("medora_emergencySos.html")

@app.route("/send_sos", methods=["POST"])
def send_sos():
    try:
        data = request.get_json()
        sender_name = data.get("sender_name", "Unknown")
        sender_number = data.get("sender_number", "Unknown")
        sos_type = data.get("type", "Emergency")
        location = data.get("location", "Unknown")
        contacts = data.get("contacts", [])

        message = (
            f"ðŸš¨ SOS ALERT ðŸš¨\n"
            f"Sender: {sender_name}\n"
            f"Contact: {sender_number}\n"
            f"Type: {sos_type}\n"
            f"Location: {location}"
        )

        sent_numbers = []
        failed_numbers = []

        for number in contacts:
            try:
                send_sms(number, message)
                sent_numbers.append(number)
            except Exception as e:
                print(f"Failed to send SMS to {number}: {e}")
                failed_numbers.append(number)
                continue

        return jsonify({
            "status": "SOS process completed!",
            "sent_to": sent_numbers,
            "failed_to": failed_numbers
        })

    except Exception as e:
        print("Error in /send_sos:", e)
        return jsonify({
            "status": "Error sending SOS",
            "sent_to": [],
            "failed_to": contacts,
            "error": str(e)
        })
